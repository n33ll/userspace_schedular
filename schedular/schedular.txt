#include "schedular.h"
#include "queues/spsc_queue.h"
#include <boost/context/continuation_fcontext.hpp>

template <typename F>
uxsched<F>::uxsched(int id){
    //initialize the queue
    _schedular_id = id;
    _queue = new spsc_queue<fiber_t<F>>(100);

    //start the runner
    _worker = new runner<F>(_queue , _schedular_id);
    _worker->run();
}

template <typename F>
fiber_t<F>* uxsched<F>::spawn(F func, int stack_size, int fiber_id){

    //add it to the runqueue
    fiber_t<F>* f = new fiber_t<F>();

    f->func = std::move(func);
    f->stack_size = stack_size;
    f->fiber_id = fiber_id;

    f->ctx = boost::context::callcc([f](boost::context::continuation&& parent){
        parent=parent.resume();
        f->func();
        return std::move(parent);
    });

    // enqueue this f
    _queue->enqueue(f);
    return f;
}